#!/bin/bash
# Pre-commit hook: Quality gates enforcement
#
# Enforces:
# 1. Code formatting (cargo fmt)
# 2. Clippy lints (zero warnings)
# 3. Tests pass
# 4. 95% code coverage (excluding wasm.rs)
#
# To install: make hooks-install
# To bypass (EMERGENCY ONLY): git commit --no-verify

set -e

echo "ðŸ” Running pre-commit quality gates..."
echo ""

# Check if we're in a rebase or merge
if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ]; then
    echo "â­ï¸  Skipping hooks during rebase"
    exit 0
fi

# 1. Format check
echo "ðŸ“ Checking code formatting..."
if ! cargo fmt -- --check > /dev/null 2>&1; then
    echo "âŒ FAIL: Code not formatted"
    echo "   Run: cargo fmt"
    exit 1
fi
echo "   âœ… Formatting OK"

# 2. Clippy
echo "ðŸ” Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings > /dev/null 2>&1; then
    echo "âŒ FAIL: Clippy warnings found"
    echo "   Run: cargo clippy --all-targets --all-features"
    exit 1
fi
echo "   âœ… Clippy OK"

# 3. Tests
echo "ðŸ§ª Running tests..."
if ! cargo test --all-features --quiet > /dev/null 2>&1; then
    echo "âŒ FAIL: Tests failed"
    echo "   Run: cargo test --all-features"
    exit 1
fi
echo "   âœ… Tests OK"

# 4. Coverage check (95% threshold, excluding wasm.rs)
echo "ðŸ“Š Checking coverage (95% threshold)..."
if command -v cargo-llvm-cov > /dev/null 2>&1; then
    # Temporarily disable mold linker
    test -f ~/.cargo/config.toml && mv ~/.cargo/config.toml ~/.cargo/config.toml.hook-backup || true

    cargo llvm-cov clean --workspace > /dev/null 2>&1
    cargo llvm-cov --no-report nextest --no-tests=warn --all-features > /dev/null 2>&1 || \
        cargo llvm-cov --no-report --all-features > /dev/null 2>&1

    # Restore config
    test -f ~/.cargo/config.toml.hook-backup && mv ~/.cargo/config.toml.hook-backup ~/.cargo/config.toml || true

    COVERAGE=$(cargo llvm-cov report 2>/dev/null | python3 -c "
import sys
lines = list(sys.stdin)
src_lines = [l for l in lines if l.startswith('src/') and 'wasm.rs' not in l]
if not src_lines:
    print('0')
    sys.exit(0)
total = sum(int(l.split()[1]) for l in src_lines)
uncov = sum(int(l.split()[2]) for l in src_lines)
cov = 100*(total-uncov)/total if total > 0 else 0
print(f'{cov:.2f}')
")

    if (( $(echo "$COVERAGE < 95" | bc -l) )); then
        echo "âŒ FAIL: Coverage ${COVERAGE}% < 95%"
        echo "   Run: make coverage"
        exit 1
    fi
    echo "   âœ… Coverage ${COVERAGE}% (â‰¥95%)"
else
    echo "   âš ï¸  cargo-llvm-cov not installed, skipping coverage check"
    echo "   Install with: cargo install cargo-llvm-cov"
fi

echo ""
echo "âœ… All pre-commit checks passed!"
exit 0
